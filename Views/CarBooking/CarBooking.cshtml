@model CarBooking.ViewModels.CarBookingVM

@{
    ViewBag.Title = Model.CarBookingId == 0 ? "Add Car Booking" : "Edit Car Booking";
}
@{
    var userIsAdmin = User.IsInRole("Admin");
    var userIsUser = User.IsInRole("User");
    bool isEdit = Model.CarBookingId > 0;
}

<style>
   
    .page-wrapper {
        padding: 25px 35px;
        background: #F4F6FA;
        min-height: 100vh;
        animation: fadeIn .4s ease;
    }

    .page-title {
        font-weight: 800;
        font-size: 28px;
        color: #D34E4E;
        border-left: 6px solid #D34E4E;
        padding-left: 12px;
        margin-bottom: 25px;
    }

    .booking-card {
        border-radius: 18px;
        padding: 30px;
        background: #ffffff;
        box-shadow: 0px 4px 15px rgba(0,0,0,0.08);
        width: 100%;
    }

        .booking-card h2 {
            font-weight: 700;
            color: #222;
            border-left: 5px solid #D34E4E;
            padding-left: 12px;
            margin-bottom: 25px;
        }

    .form-label {
        font-weight: 600;
        color: #333 !important;
    }

    .form-control {
        border-radius: 10px !important;
        padding: 10px 14px;
        border: 1.5px solid #d6d6d6 !important;
        transition: .25s ease;
    }

        .form-control:focus {
            border-color: #D34E4E !important;
            box-shadow: 0 0 10px rgba(255,75,43,0.25);
        }

    .select2-selection {
        padding: 6px !important;
        border-radius: 10px !important;
        height: 45px !important;
        display: flex !important;
        align-items: center;
        border: 1.5px solid #ccc !important;
    }

    #carDetails {
        border-radius: 15px;
        background: #f8f9fa;
        transition: .3s;
        border: 1px solid #e5e5e5;
    }

        #carDetails .card-header {
            background: linear-gradient(45deg, #D34E4E, #FF6F61);
            padding: 15px;
            font-size: 18px;
            border-radius: 15px 15px 0 0;
            color: #fff;
        }

    #carImages {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
        margin-top: 15px;
        width: 90%; 
        margin-left: auto; 
        margin-right: auto;
    }

  
    .car-image-box {
        height: 200px;
        border-radius: 12px;
        overflow: hidden;
        background: white;
        box-shadow: 0 5px 15px rgba(0,0,0,0.08);
    }

        .car-image-box img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            cursor: pointer;
            transition: transform .3s ease;
        }

        .car-image-box:hover img {
            transform: scale(1.1);
        }

    .btn-save {
        background-color: #D34E4E !important;
        color: white !important;
        padding: 10px 22px;
        border-radius: 10px;
        font-weight: 600;
        border: none;
    }

    .image-zoom-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 99999;
    }

        .image-zoom-overlay img {
            width: 100%;
            height: auto;
            max-width: 1200px;
            max-height: 90vh;
            object-fit: contain;
            border-radius: 10px;
            box-shadow: 0 0 30px rgba(255,255,255,0.4);
        }

    @@keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

</style>

<div class="page-wrapper">

    <div class="booking-card shadow p-4">
        @if (userIsAdmin)
        {
            <h2 class="page-title mb-4">@ViewBag.Title</h2>
        }
        else
        {
            <h2 class="page-title mb-4">Booked Car Detail</h2>
        }


        <form asp-action="CarBooking" id="bookingForm" method="post">
            <input type="hidden" asp-for="CarBookingId" />
            <input type="hidden" id="ErrorMsg" value="@TempData["Error"]" />


            <div class="mb-4">
                <label for="CarId" class="form-label">Select Car</label>

                <select id="CarId" name="CarId" class="form-control"
                        data-selected="@Model.CarId" @(isEdit ? "disabled" : "")></select>

                @if (isEdit)
                {
                    <input type="hidden" name="CarId" value="@Model.CarId" />
                }

                <span asp-validation-for="CarId" class="text-danger"></span>
            </div>
       
            <div class="card mb-4 shadow-sm" id="carDetails" style="display:none;">
                <div class="card-header">
                    Car Details
                </div>

                <div class="card-body">
                    <div class="row mb-2">
                        <div class="col-md-6"><strong>Car Name:</strong> <span id="carName"></span></div>
                        <div class="col-md-6"><strong>Car Number:</strong> <span id="carNumber"></span></div>
                    </div>

                    <div class="row mb-2">
                        <div class="col-md-6"><strong>PUC:</strong> <span id="carPuc"></span></div>
                        <div class="col-md-6"><strong>Per Day Price:</strong> <span id="carExPrice"></span></div>
                    </div>

                    <div class="row mb-2">
                        <div class="col-md-6"><strong>Insurance:</strong> <span id="carInsurance"></span></div>
                        <div class="col-md-6"><strong>Registration Year:</strong> <span id="carRegisterYear"></span></div>
                    </div>
                </div>
            </div>
        
            <div class="mb-4">
                <label class="form-label">Car Images</label>

                <div id="carImages" class="d-flex flex-wrap gap-2"></div>

                <div class="image-zoom-overlay" id="imgZoomOverlay">
                    <img id="zoomedImg" src="" />
                </div>
            </div>

           
            @if (userIsAdmin)
            {
                <div class="row mb-3">
                    <div class="col-md-4">
                        <label asp-for="StartDate" class="form-label">Start Date</label>
                        <input type="date" asp-for="StartDate" class="form-control" value="@Model.StartDate.ToString("yyyy-MM-dd")" />
                        <span asp-validation-for="StartDate" class="text-danger"></span>
                    </div>

                    <div class="col-md-4">
                        <label asp-for="EndDate" class="form-label">End Date</label>
                        <input type="date" asp-for="EndDate" class="form-control" value="@Model.EndDate.ToString("yyyy-MM-dd")" />
                        <span asp-validation-for="EndDate" class="text-danger"></span>
                    </div>

                    <div class="col-md-4">
                        <label asp-for="TotalAmount" class="form-label">Total Amount</label>
                        <input asp-for="TotalAmount" class="form-control" />
                        <span asp-validation-for="TotalAmount" class="text-danger"></span>
                    </div>
                </div>
            }
            else if (Model.CarBookingId != 0 && userIsUser)
            {
                <div class="row mb-3">
                    <div class="col-md-4">
                        <label asp-for="StartDate" class="form-label">Start Date</label>
                        <input type="date" asp-for="StartDate" class="form-control" value="@Model.StartDate.ToString("yyyy-MM-dd")" readonly />
                        <span asp-validation-for="StartDate" class="text-danger"></span>
                    </div>

                    <div class="col-md-4">
                        <label asp-for="EndDate" class="form-label">End Date</label>
                        <input type="date" asp-for="EndDate" class="form-control" value="@Model.EndDate.ToString("yyyy-MM-dd")" readonly />
                        <span asp-validation-for="EndDate" class="text-danger"></span>
                    </div>

                    <div class="col-md-4">
                        <label asp-for="TotalAmount" class="form-label">Total Amount</label>
                        <input asp-for="TotalAmount" class="form-control" readonly />
                        <span asp-validation-for="TotalAmount" class="text-danger"></span>
                    </div>
                </div>
            }
            else if (Model.CarBookingId == 0 && userIsUser)
            {
                <div class="row mb-3">
                    <div class="col-md-4">
                        <label asp-for="StartDate" class="form-label">Start Date</label>
                        <input type="date" asp-for="StartDate" class="form-control" value="@Model.StartDate.ToString("yyyy-MM-dd")"  />
                        <span asp-validation-for="StartDate" class="text-danger"></span>
                    </div>

                    <div class="col-md-4">
                        <label asp-for="EndDate" class="form-label">End Date</label>
                        <input type="date" asp-for="EndDate" class="form-control" value="@Model.EndDate.ToString("yyyy-MM-dd")"  />
                        <span asp-validation-for="EndDate" class="text-danger"></span>
                    </div>

                    <div class="col-md-4">
                        <label asp-for="TotalAmount" class="form-label">Total Amount</label>
                        <input asp-for="TotalAmount" class="form-control" readonly />
                        <span asp-validation-for="TotalAmount" class="text-danger"></span>
                    </div>
                </div>
            }
          
            @if (Model.CarBookingId == 0)
            {
                <button type="submit" class="btn"
                        style="background-color:#D34E4E;color:white;border-color:#FF4B2B;">
                    Save Booking
                </button>
            }

            @if (Model.CarBookingId > 0 && userIsAdmin)
            {
                <button type="submit" class="btn"
                        style="background-color:#D34E4E;color:white;border-color:#FF4B2B;">
                    Update Booking
                </button>
            }

            <a href="/CarBooking/GetAllCarBookingList" class="btn btn-secondary mt-3">Cancel</a>

        </form>

    </div> 

</div> 
@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="~/js/site.js"></script>
    <script>
        $(document).ready(function () {

                  $(document).on("click", ".car-image-box img", function () {
            let imgSrc = $(this).attr("src");
            $("#zoomedImg").attr("src", imgSrc);
            $("#imgZoomOverlay").fadeIn(200);
        });

        $("#imgZoomOverlay").click(function () {
            $(this).fadeOut(200);
        });
            var modelStateHasErrors = @(ViewData.ModelState.IsValid ? "false" : "true");
            var selectedCarId = $('#CarId').data('selected');
                $('#CarId').select2({
                    placeholder: "Select Car",
                    width: "100%"
                });

            if (!modelStateHasErrors || $('#CarId option').length <= 1) {
                loadCarList(selectedCarId);
            }

            $('#CarId').on('change', function () {
                var selected = $(this).val();
                if (selected) {
                    loadCarDetails(selected);
                    calculateAmount();
                }
            });

            $('#StartDate, #EndDate').on('change', calculateAmount);
        });

        function loadCarList(selectedCarId) {
            $.ajax({
                url: '/CarBooking/GetCarList',
                type: 'GET',
                dataType: 'json',
                success: function (data) {
                    var carSelect = $('#CarId');
                    carSelect.empty().append('<option value="">-- Select Car --</option>');

                    $.each(data, function (i, car) {
                        carSelect.append(`<option value="${car.id}">${car.name}</option>`);
                    });

                    if (selectedCarId && selectedCarId > 0) {
                        carSelect.val(selectedCarId);
                        loadCarDetails(selectedCarId);
                    }
                }
            });
        }
         function loadCarDetails(carId) {
            $.ajax({
                url: '/CarBooking/GetCarDetails',
                type: 'GET',
                data: { carId: carId },
                success: function (car) {

        function formatDateToDDMMYYYY(dateString) {
            const date = new Date(dateString);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();

            return `${day}/${month}/${year}`;
        }

                    $('#carDetails').fadeIn();
                    $('#carName').text(car.carName);
                    $('#carNumber').text(car.carNumber);
                    $('#carExPrice').text(car.pricePerDay);
                    $('#carPuc').text(formatDateToDDMMYYYY(car.pucexpireDate));
                    $('#carInsurance').text(formatDateToDDMMYYYY(car.insuranceDate));
                    $('#carRegisterYear').text(formatDateToDDMMYYYY(car.registerDate));
                    if (car.images && car.images.length > 0) {
                    var imagesHtml = "";
                    car.images.forEach(img => {
                        if (img.imagePath.toLowerCase().endsWith(".pdf")) {
                            imagesHtml += `
                                <div class="car-image-box">
                                    <iframe src="${img.imagePath}"></iframe>
                                </div>`;
                        } else {
                            imagesHtml += `
                                <div class="car-image-box">
                                    <img src="${img.imagePath}" />
                                </div>`;
                        }
                    });

                    $("#carImages").html(imagesHtml);
                    } else {
                        $('#carImages').html('<p class="text-muted">No images available for this car.</p>');
                    }

                    // if (car.images && car.images.length > 0) {
                    //    var imagesHtml = '';
                    //    car.images.forEach(function (image) {
                    //        if (image.imagePath.toLowerCase().endsWith('.pdf')) {
                    //            imagesHtml += `<iframe src="${image.imagePath}" width="250" height="250" class="img-thumbnail shadow-sm" loading="lazy"></iframe>`;
                    //        } else {
                    //            imagesHtml += `<img src="${image.imagePath}" class="img-thumbnail shadow-sm" width="250" alt="Car Image" loading="lazy" />`;
                    //        }
                    //    });
                    //    $('#carImages').html(imagesHtml);
                    // } else {
                    //     $('#carImages').html('<p class="text-muted">No images available for this car.</p>');
                    // }

                },
                error: function (xhr, status, error) {
                    console.error('Error loading car details:', error);
                }
            });
        }

        function calculateAmount() {
            var start = $('#StartDate').val();
            var end = $('#EndDate').val();
            var carId = $('#CarId').val();
            if (!start || !end || !carId){
            return;
            }
            var startDate = new Date(start);
            var endDate = new Date(end);

            if (endDate < startDate) {
                $('#TotalAmount').val('');
                return;
            }

            var timeDiff = endDate - startDate;
            var days = Math.floor(timeDiff / (1000 * 60 * 60 * 24)) + 1;

            $.ajax({
                url: '/CarBooking/GetCarPrice',
                type: 'GET',
                data: { carId: carId },
                success: function (price) {
                    if (!price || isNaN(price)) {
                        $('#TotalAmount').val('');
                        return;
                    }
                    var totalAmount = price * days;

                    $('#TotalAmount').val(totalAmount);
                }
            });
        }
        $("#bookingForm").submit(function (e) {
            e.preventDefault();

            let errors = [];
            var startDateVal = $('#StartDate').val();
            var endDateVal = $('#EndDate').val();
            var carId = $('#CarId').val();
            var bookingId = $('#CarBookingId').val() || 0;
            var today = new Date();
            today.setHours(0, 0, 0, 0);

            if (!startDateVal) errors.push("Start Date is required.");
            if (!endDateVal) errors.push("End Date is required.");
            if (!carId || carId === "0") errors.push("Car selection is required.");

            var startDate = new Date(startDateVal);
            var endDate = new Date(endDateVal);

             
            //  if (startDate < today) {
            //       errors.push("Start Date must be greater than or equal to Today.");
            // }
              

            if (startDate > endDate) {
                errors.push("End Date must be greater than or equal to Start Date.");
            }

            if (errors.length > 0) {
                Swal.fire({
                    icon: "error",
                    title: "Validation Error",
                    html: errors.join("<br>")
                });
                return false;
            }
        var $form = $(this);
                $.ajax({
                url: "/CarBooking/CheckCarAvailability",
                type: "GET",
                data: {
                    carId: carId,
                    startDate: startDateVal,
                    endDate: endDateVal,
                    bookingId: bookingId
                },
                success: function (response) {

                    if (!response.isAvailable) {
                        Swal.fire({
                            icon: "error",
                            title: "Booking Conflict",
                            text: response.errorMessage || "This car is already booked for the selected dates."
                        });
                        return false;
                    } else {
                $form[0].submit();
                    }
                },
                error: function() {
                    Swal.fire({
                        icon: "error",
                        title: "Error",
                        text: "An error occurred while checking car availability."
                    });
                }
            });


  

        });
    </script>
}